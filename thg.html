<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <title>THG Tour</title>
  <link rel="stylesheet" href="style.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
</head>

<body>
    <div id="player"></div>
    <div id="InfoPlayer"></div>
    <div id="InfoBanner">
      <div id="BannerWrapper">
        <h5 id="bannerTitle">Banner</h5>
        <p id="bannerText">Sample banner text. If you see this, something went wrong<br>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        <span class="material-icons" id="bannerCloseIcon">close</span>
      </div>
    </div>
  <div class="wrapper">
    <div class="buttonDiv">
      <h1>Wechseln</h1>
    </div>
  </div>
  <div class="controls">
    <span class="material-icons icon forward">keyboard_arrow_up</span>
    <span class="material-icons icon backward">keyboard_arrow_down</span>
  </div>
  <div class="nav">
    <span class="material-icons icon menu-icon" id="openIcon">menu</span>
    <div id="menuIconWrapper">
      <span class="material-icons icon menu-icon hiddenIcon" id="closeIcon">close</span>
      <span class="material-icons icon menu-icon hiddenIcon" id="homeIcon" title="Startseite">logout</span>
      <span class="material-icons icon menu-icon hiddenIcon" id="floorIcon" title="Stockwerke">room</span>
      <span class="material-icons icon menu-icon hiddenIcon" id="videosIcon" title="Videos">movie</span>
    </div>
    <div class="secondLayer" id="floorWrapper">
      <span class="material-icons icon menu-icon hiddenIcon" id="closeIconFloor">close</span>
      <div class="navSecContainer">
        <h1>Stockwerke</h1><br>
        <p id="EG">Ergeschoss</p><br>
        <p id="S1">1. Stock</p><br>
        <p id="S2">2. Stock</p><br>
        <p id="S3">3. Stock</p>
      </div>
    </div>
    <div class="secondLayer" id="videoWrapper">
      <span class="material-icons icon menu-icon hiddenIcon" id="closeIconVideo">close</span>
      <div class="navSecContainer">
        <h1>Videos</h1><br>
        <p id="V1">Chemie</p><br>
        <p id="V2">Physik</p><br>
        <p id="V3">Deutsch</p><br>
        <p id="V4">Erdkunde</p>
      </div>
    </div>
  </div>

  <script type="text/javascript" charset="utf-8" src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"> </script>
  <script type="text/javascript" charset="utf-8" src="dist/clappr-video360.min.js"></script>
  <script type="text/javascript" charset="utf-8">


                  // online ,           localer pi            , relative
    let server = ['http://93.90.200.83','http://192.168.0.89','.'];   //neu Art den res Server zu wählen
    var serverwahl = 0;       //diese Zahl ändern um Manuel anderen Server zu wählen
    var Gang = "/res/THG/Gang/";
    var Raum = "/res/THG/Raum/";


    var playbackRate = 2;

    var beginVideoUrl ; // das erste Video das geladen wird


    var Rundgang = 0; //352

    var IdTrepOst = 1;  //91
    var IdEG1 = 2;    //84                 //Video Id's
    var IdEG2 = 3;    //33s                 // bestimmt durch die Reinfolge der array
    var Id1OG = 4;    //91s
    var Id2OG = 5;    //134s
    var Id3OG = 6;    //79s


    var IdObers = 7;
    var Id227 = 8;
    var Id229 = 9;
    var Id339 = 10;

    var InfoRunning = false;

    let array ;
    let InfoVideos;

    var dir = true;
    var forwardAllowed = true;
    var backwardAllowed = false;
    var barrier = 0.5;

    var justStarted = true;
    var firstWalk = true;

    var NewTime;
    var videoId_old;
    var videoId = 0;
    var currentLable_old;
    var currentLable = 0; // 0 = kein Lable ist gesetzt, zahl entspricht sonst array
    var Walkable = true;
    var changed = false;

    var bannerSafe = true;
    var bannerSafeLock = false;


    /*
    [Videos
      [Stellen
        [ButtonName, SourceLink, StartTime, EndTime, NewVideoId, NewTime, Walkable, LabelSet, autoJump, infovideo ID]
      ]
    ]
    */
      beginVideoUrl = server[serverwahl]+ Gang + 'Draussen.mp4' ;
      var beginZeit = 0; // noch nicht berücksichtigt
      //beginVideoUrl = server[serverwahl]+'/res/THG/Vid_Oberstufe.mp4'

      array = [
        [
          // Video draußen Rundgang
            ['Zum THG', server[serverwahl]+ Gang + 'Draussen.mp4', 0, 3, Rundgang, 175, true, false, false],
            ['KGW - Halle', server[serverwahl]+ Raum + 'XXXXX', 9, 14, "XXXXX", 1, false, false],
            ['THG - Halle', server[serverwahl]+ Raum + 'XXXXX', 38, 42, "XXXXX", 1, false, false],
            ['Eingang', server[serverwahl]+ Gang + 'EG_1.mp4', 60, 65, IdEG1, 29, true, false],
            ['Zur Rosavilla', server[serverwahl]+ Gang + 'XXXXX', 118, 121, "XXXXX", 0, true, false],
            ['Eingang', server[serverwahl]+ Gang + 'TrepOst.mp4', 125, 128, IdTrepOst, 0, true, false],
            ['Zum EG', server[serverwahl]+ Gang + 'EG_1.mp4', 153, 156, IdEG1, 17, true, false],
            ['E-Gebäude', server[serverwahl]+ Gang + 'XXXXX', 162, 165, "XXXXX", 0, true, false],
            ['Zu den Sporhallen', server[serverwahl]+ Gang + 'Draussen.mp4', 174, 177, Rundgang, 3, true, false, false]

        ],
        [
          ['Rundgang Pausenhof', server[serverwahl]+ Gang + 'Draussen.mp4' , 0, 2, Rundgang, 126, true, false],
          ['EG', server[serverwahl]+ Gang + 'EG_1.mp4', 7, 9, IdEG1, 0, true, false],
          ['1.OG', server[serverwahl]+ Gang+ '1OG.mp4', 20, 22, Id1OG, 0, true, false],    //Video Treppe ost
          ['2.OG', server[serverwahl]+ Gang+ '2OG.mp4', 33, 35, Id2OG, 0, true, false],
          ['3.OG', server[serverwahl]+ Gang + '3OG.mp4', 43, 47, Id3OG, 0, true, false]
        ],
        [//Video EG-1 (rechts)
          ['Treppe', server[serverwahl]+ Gang + 'TrepOst.mp4', 0, 3, IdTrepOst, 8, true, false],
          ['Musik', server[serverwahl]+ Raum + 'XXXXX', 6, 8, "XXXXX", 1, false, false],
          ['2-EG', server[serverwahl]+ Gang + 'EG_2.mp4', 13, 15, IdEG2, 15, true, false],
          ['Zum E-Gebäude', server[serverwahl]+ Gang + 'Draussen.mp4', 16, 18, Rundgang, 155, false, false],
          ['Aula', server[serverwahl]+ Raum + 'XXXXXX', 25, 27, "XXXXX", 1, false, false],
          ['Zum Haupteingang', server[serverwahl]+ Gang + 'Draussen.mp4', 28, 30, Rundgang, 62, true, false],
          ['2-EG', server[serverwahl]+ Gang + 'EG_2.mp4', 30, 32, IdEG2, 0, true, false],
          ['1.OG', server[serverwahl]+ Gang + '1OG.mp4', 39, 42, Id1OG, 24, true, false, false]  //autoJump enable pos 8
        ],
        [ //Video EG-2 (links)
          ['1-EG', server[serverwahl]+ Gang + 'EG_1.mp4', 0, 2, IdEG1, 31, true, false],
          ['Deutsch', server[serverwahl]+ Raum + 'XXXXX', 4, 6, "XXXXX", 1, false, false],
          ['1-EG', server[serverwahl]+ Gang + 'EG_1.mp4', 13, 16, IdEG1, 14, true, false]
        ],
        [// Video OG1
          ['Banner',  , 4, 5,'Test','Beispieltext muss hier rein; \n If you see this something went horribly wrong!'],
          ['Treppe', server[serverwahl]+ Gang + 'TrepOst.mp4', 0, 3, IdTrepOst, 21, true, false], // Video OG1
          ['Mathe', server[serverwahl]+ Raum + 'EG_1.mp4', 12, 14, "XXXXXX", 1, true, false],
          ['Zum E-Gebäude', server[serverwahl]+ Gang + 'XXXXXXX', 15, 17, "XXXXXX", 45, true, false],
          ['Treppe', server[serverwahl]+ Gang + 'EG_1.mp4', 18, 20, IdEG1, 45, true, false],
          ['Oberstufe', server[serverwahl]+ Raum + 'Oberstufe.mp4', 35, 37, IdObers , 1, false, false],
          ['2.OG', server[serverwahl]+ Gang + '2OG.mp4', 44, 50, Id2OG, 24, true, false, false],  //autoJump enable pos 8 = true
        ],
        [//Video OG 2

          ['Treppe', server[serverwahl]+ Gang + 'TrepOst.mp4', 0, 2, IdTrepOst, 34, true, false],  //Video OG 2
          ['Biologie 1', server[serverwahl]+ Raum + 'XXXXXX', 2, 4, Id227 , 1, false, false],
          ['Biologie 2', server[serverwahl]+ Raum + 'XXXXXXX', 7, 9, Id227 , 1, false, false],
          ['Treppe', server[serverwahl]+ Gang + '1OG.mp4', 22, 24, Id1OG, 48, true, false],
          ['Erdkunde 227', server[serverwahl]+ Raum + '227.mp4', 34, 36, Id227 , 1, false, false],
          ['Englisch 229', server[serverwahl]+ Raum + '229.mp4', 36, 38, Id229 , 1, false, false],
          ['Latein', server[serverwahl]+ Raum + 'XXXXX', 38, 40, "XXXXXX" , 1, false, false],
          ['3.OG', server[serverwahl]+ Gang + '3OG.mp4', 51, 54, Id3OG, 24, true, false, false],    //autoJump enable pos 8
        ],







        [ //Video OG 3

          ['Treppe', server[serverwahl]+ Gang + 'TrepOst.mp4', 0, 3, IdTrepOst, 46, true, false],
          ['Chemie', server[serverwahl]+ Raum + 'XXXXXX', 8, 10, "XXXXXX" , 1, false, false],
          ['Bildene Kunst', server[serverwahl]+ Raum + 'XXXXXX', 19, 21, "XXXXX" , 1, false, false],


          ['Treppe', server[serverwahl]+ Gang + '2OG.mp4', 24, 26, Id2OG, 53, true, false], //Video OG 3
          ['Physik 339', server[serverwahl]+ Raum + '339.mp4', 36, 38, Id339 , 1, false, false],
        ],









        [
          ['1.OG', server[serverwahl]+ Gang + '1OG.mp4', 0, 5, Id1OG, 36, true, false, false, 0]   //BILD Oberstufenzimmer; autoJump disabled pos 8 = false; infovideo ID = pos 9
        ],
        [
          ['2.OG', server[serverwahl]+ Gang + '2OG.mp4', 0, 5, Id2OG, 40, true, false, false, 1]   //BILD Erdkunde 227
        ],
        [
          ['2.OG', server[serverwahl]+ Gang + '2OG.mp4', 0, 5, Id2OG, 21, true, false, false, 1]   //BILD Erdkunde 229
        ],
        [
          ['3.OG', server[serverwahl]+ Gang + '3OG.mp4', 0, 5, Id3OG, 37, true, false, false, 1]   //BILD Physik 339
        ]

      ];

      InfoVideos = [server[serverwahl]+'/res/THG/THG_Aalen_Eisenbahn.mp4',
      server[serverwahl]+'/res/THG/THG_Aalen_Eisenbahn.mp4',
      server[serverwahl]+'/res/THG/THG_Aalen_Eisenbahn.mp4',
      server[serverwahl]+'/res/THG/THG_Aalen_Eisenbahn.mp4',
      server[serverwahl]+'/res/THG/THG_Aalen_Eisenbahn.mp4'];
        // sources der Infovideos abhängig von dem Aktiven 360 Zimmer bild

    console.log(array[0][0][0]);

    var p = new Clappr.Player({
      poster: "./res/THG-outside.png",
      source: beginVideoUrl,
      width: window.innerWidth,
      height: window.innerHeight,
      preload: 'auto',
      chromeless: true,
      mute: true,
      plugins: [Video360],
      parentId: '#player',
      events: {onPlay: function (){
        if (justStarted){
          if (changed){
            p.seek(NewTime);
            p.play();
            changed = false;
            Walkable = array[videoId_old][currentLable_old][6];
          }
          p.pause();
          justStarted = false;
        }
      }
    },
  });
    p.getPlugin('click_to_pause').disable();
    p.core.activeContainer.on(Clappr.Events.CONTAINER_STATE_BUFFERING, function() {console.log("Buffered");if(firstWalk){setTimeout(function() {console.log("play");p.play();setTimeout(function() {p.pause();},100);}, 1000);}});

    p.core.activePlayback.el.playbackRate = playbackRate;

    p.play();
    //var startTimer = setTimeout(() => {p.pause();}, 1000);
    var isFirefox = typeof InstallTrigger !== 'undefined';

    if (isFirefox){
      setInterval(()=> {if(firstWalk){p.play();p.pause(); console.log();}},100);
    }

    setInterval(() =>{
      if(justStarted){
        p.play();
        console.log("starting");
      }
    }, 100);

    setInterval(() => {
      if (Walkable){
        if (dir && (p.getCurrentTime() >  (p.getDuration()/2)-barrier)) {
          p.pause();
          forwardAllowed = false;
        } else if (!dir && (p.getCurrentTime() > p.getDuration()-barrier)) {
          p.pause();
          backwardAllowed = false;
        } else {
          forwardAllowed = true;
          backwardAllowed = true;
        }
      }
    }, 100);

    // controll Intervall für Labels
    setInterval(() => {
        for(var i =0; i< array[videoId].length; i++ ){
          try {
            var LabelStart = array[videoId][i][2];
            var LabelEnd = array[videoId][i][3];
            var LabelSet = array[videoId][i][7];
            /*console.log("Start" + LabelStart);
            var control = p.getDuration() - p.getCurrentTime();
            console.log("currentTime_reverse" + control);
            console.log("currentTime" + p.getCurrentTime());
            console.log("Ende" + LabelEnd);*/
            if ((p.getCurrentTime() > LabelStart && p.getCurrentTime() < LabelEnd ) && array[videoId][i][0] != 'Banner'){
              currentLable = i;
              setLableText(array[videoId][currentLable][0]);
              array[videoId][i][7] = true;

              if (array[videoId][currentLable][8] == true){
                if(p.getCurrentTime() > (LabelStart+1) && p.getCurrentTime() < LabelEnd){
                  changeVideo(array[videoId][currentLable][1], array[videoId][currentLable][5], array[videoId][currentLable][4]);
                }
              }
            }else if ((p.getDuration()-p.getCurrentTime()) > LabelStart && (p.getDuration() - p.getCurrentTime()) < LabelEnd  && array[videoId][i][0] != 'Banner') {
              currentLable = i;
              setLable(currentLable);
              array[videoId][i][7] = true;

              if (array[videoId][currentLable][8] == true){
                if(p.getDuration()-p.getCurrentTime() > (LabelStart+1) && (p.getDuration() - p.getCurrentTime()) < LabelEnd){
                  changeVideo(array[videoId][currentLable][1], array[videoId][currentLable][5], array[videoId][currentLable][4]);
                }
              }
            }else if (LabelSet){
              array[videoId][i][7] = false;
              hideLable();
              currentLable = 0;
            }
        }catch (e) {
          console.log("Video Id: " + videoId);
          console.log("label check: " + i);
          console.log(e);
        }
      }
    },100);

    setInterval(() => {p.resize({height: window.innerHeight, width: window.innerWidth});
      //document.getElementById("InfoPlayer").style.height = window.innerHeight;
      //document.getElementById("InfoPlayer").style.width = window.innerWidth;
    }, 1000);

    function setLable(label) {
      document.querySelector(".buttonDiv h1").innerHTML = array[videoId][label][0];
      document.querySelector(".buttonDiv").style.visibility = "visible"
    };

    function setLableText(Textset) {
      document.querySelector(".buttonDiv h1").innerHTML = Textset;
      document.querySelector(".buttonDiv").style.visibility = "visible"
    };

    function hideLable() {
      document.querySelector(".buttonDiv").style.visibility = "collapse"
    };

    function walkForward() {
      firstWalk = false;
      if (p.getCurrentTime() > (p.getDuration()/2)) {p.seek(p.getDuration()-p.getCurrentTime());}
      dir = true;
      backwardAllowed = true;
        p.play();
    }

    function walkBackward() {
      firstWalk = false;
      if (p.getCurrentTime() < (p.getDuration()/2)) {p.seek(p.getDuration()-p.getCurrentTime());}
      dir = false;
      forwardAllowed = true;
      p.play();
    }

    document.onkeydown = function(e) {
      if (Walkable){
        if ((e.code == "ArrowUp" || e.code == "ArrowRight" || e.code == "KeyW" || e.code == "KeyD") && forwardAllowed) {
          if(Walkable){
            walkForward();
          }
        }else if ((e.code == "ArrowDown" || e.code == "ArrowLeft" || e.code == "KeyA" || e.code == "KeyS") && backwardAllowed) {
          if(Walkable){
            walkBackward();
          }
        }
      }else if (e.code == "KeyI"){
        startInfo(InfoVideos[array[videoId][0][9]]);
      }
      if (e.code == "KeyT"){
        for(var i = 0; i<array[videoId].length;i++){
          console.log(i);
          var LabelStart = array[videoId][i][2];
          var LabelEnd = array[videoId][i][3];
          if(array[videoId][i][0]=="Banner" && array && ((p.getCurrentTime() > LabelStart && p.getCurrentTime() < LabelEnd) || ((p.getDuration()-p.getCurrentTime()) > LabelStart && (p.getDuration() - p.getCurrentTime()) < LabelEnd ) )) {
            startInfoBanner(array[videoId][i][4], array[videoId][i][5]);
          }
        }
      }
      if (e.code == "Escape") {
          endInfo();
      }
    };

    function startInfo (source){
      if(!InfoRunning){
        InfoRunning = true;
        Walkable = false;
        var c = document.getElementById("InfoPlayer");
        var v = document.createElement("video");
        v.setAttribute("id", "D2Player")
        v.Type = "video/mp4";
        v.src = source;
        v.controls = true;
        c.style.zIndex = 7;
        document.getElementById('player').style.zIndex = -10 ;
        c.appendChild(v);
        v.play();
      }
    }

    function endInfo(){
      if(InfoRunning){
        try{
          Walkable = true;
          var v = document.getElementById('D2Player');
          v.remove();
          document.getElementById("InfoPlayer").style.zIndex = -10;
          document.getElementById('player').style.zIndex = 6 ;
          InfoRunning = false;
        }catch(e){
          console.log("kein 2D Player" + e);
        }
      }
    }

    function startInfoBanner(Überschrift, Content) {
      document.getElementById('bannerTitle').innerHTML = Überschrift;
      document.getElementById('bannerText').innerHTML = Content;
      document.querySelector("#InfoBanner").style.zIndex = 8;
      document.querySelector("#player").style.zIndex = -10 ;
      if (!bannerSafeLock) {
        bannerSafe = Walkable;
        bannerSafeLock = true;
        Walkable = false;
      }
    }

    function endInfoBanner() {
      document.querySelector("#InfoBanner").style.zIndex = -10;
      document.querySelector("#player").style.zIndex = 6;
      Walkable = bannerSafe;
      bannerSafeLock = false;
    }

    document.onkeyup = function(e) {
      if (e.code == "ArrowUp" || e.code == "ArrowRight" || e.code == "KeyW" || e.code == "KeyD") {
        p.pause();
      } else if (e.code == "ArrowDown" || e.code == "ArrowLeft" || e.code == "KeyA" || e.code == "KeyS") {
        p.pause();
      }
    };

    document.querySelector(".buttonDiv").addEventListener("click", (e) => {

      changeVideo(array[videoId][currentLable][1], array[videoId][currentLable][5], array[videoId][currentLable][4]);

    });

    function changeVideo(source, time, nVideoId ){
      Walkable = false;
      array[videoId][currentLable][7] = false;
      var new_source = source; //
      changed = true;
      hideLable();
      NewTime = time; //
      videoId_old = videoId;
      currentLable_old = currentLable;
      videoId = nVideoId;
      currentLable = 0;
      justStarted = true;
      forwardAllowed = true;
      firstWalk = true;
      p.load(new_source);
      p.core.activePlayback.el.playbackRate = playbackRate;
    }


    window.addEventListener("contextmenu", function(e) { e.preventDefault(); });

    document.querySelector(".forward").addEventListener("touchstart", (e) => {walkForward();console.log("Start");});
    document.querySelector(".forward").addEventListener("touchend", (e) => {p.pause();console.log("End");});
    document.querySelector(".backward").addEventListener("touchstart", (e) => {walkBackward();console.log("Start");});
    document.querySelector(".backward").addEventListener("touchend", (e) => {p.pause();console.log("End");});

    document.querySelector("#openIcon").addEventListener("click", (e) => {
      document.querySelector("#menuIconWrapper").style.transform = "translate(4.4em, 0)";
    });

    document.querySelector("#closeIcon").addEventListener("click", (e) => {
      document.querySelector("#menuIconWrapper").style.transform = "translate(-4.4em, 0)"
    });

    document.querySelector("#homeIcon").addEventListener("click", (e) => {
      window.location.href = "http://www.thgaalen.de";
    });

    document.querySelector("#floorIcon").addEventListener("click", (e) => {
      document.querySelector("#floorWrapper").style.transform = "translate(16em, 0)";
    });

    document.querySelector("#closeIconFloor").addEventListener("click", (e) => {
      document.querySelector("#floorWrapper").style.transform = "translate(-16em, 0)"
    });

    document.querySelector("#videosIcon").addEventListener("click", (e) => {
      document.querySelector("#videoWrapper").style.transform = "translate(16em, 0)";
    });

    document.querySelector("#closeIconVideo").addEventListener("click", (e) => {
      document.querySelector("#videoWrapper").style.transform = "translate(-16em, 0)"
    });

    document.querySelector("#EG").addEventListener("click", (e) => {changeVideo(server[serverwahl]+ Gang + 'EG_1.mp4', 0, IdEG1);menuCollapseFromFloors();});
    document.querySelector("#S1").addEventListener("click", (e) => {changeVideo(server[serverwahl]+ Gang + '1OG.mp4', 0, Id1OG);menuCollapseFromFloors();});
    document.querySelector("#S2").addEventListener("click", (e) => {changeVideo(server[serverwahl]+ Gang + '2OG.mp4', 0, Id2OG);menuCollapseFromFloors();});
    document.querySelector("#S3").addEventListener("click", (e) => {changeVideo(server[serverwahl]+ Gang + '3OG.mp4', 0, Id3OG);menuCollapseFromFloors();});

    document.querySelector("#V1").addEventListener("click", (e) => {startInfo(server[serverwahl]+ Info +'THG_Aalen_Eisenbahn.mp4');menuCollapseFromVideos();});
    document.querySelector("#V2").addEventListener("click", (e) => {console.log("V2");menuCollapseFromVideos();});
    document.querySelector("#V3").addEventListener("click", (e) => {console.log("V3");menuCollapseFromVideos();});
    document.querySelector("#V4").addEventListener("click", (e) => {console.log("V4");menuCollapseFromVideos();});

    function menuCollapseFromFloors() {
      document.querySelector("#floorWrapper").style.transform = "translate(-16em, 0)"
      document.querySelector("#menuIconWrapper").style.transform = "translate(-4.4em, 0)"
    }

    function menuCollapseFromVideos() {
      document.querySelector("#videoWrapper").style.transform = "translate(-16em, 0)"
      document.querySelector("#menuIconWrapper").style.transform = "translate(-4.4em, 0)"
    }

    document.querySelector("#bannerCloseIcon").addEventListener("click", (e) => {endInfoBanner();});
  </script>
</body>
</html>
