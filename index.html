
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <title>THG Tour</title>
  <link rel="stylesheet" href="style.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
  <div id="player"></div>
  <div class="wrapper">
    <div class="buttonDiv">
      <h1>Wechseln</h1>
    </div>
  </div>
  <div class="controls">
    <span class="material-icons icon forward">keyboard_arrow_up</span>
    <span class="material-icons icon backward">keyboard_arrow_down</span>
  </div>

  <script type="text/javascript" charset="utf-8" src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"> </script>
  <script type="text/javascript" charset="utf-8" src="dist/clappr-video360.min.js"></script>
  <script type="text/javascript" charset="utf-8">

    var local = false; // true -> nur wenn index auf Server laufen soll

    var beginVideoUrl ; // das erste Video das geladen wird
    var testUrl = 'http://thiago.me/demo-360/cool.mp4';

    var IdTrepOst = 0;  // 108
    var IdEG1 = 1;    // 100                 //Video Id's
    var IdEG2 = 2;    // 32s                 // bestimmt durch die Reinfolge der array
    var Id1OG = 3;    // 99s
    var Id2OG = 4;    //134s
    var Id3OG = 5;    //79s

    var IdObers = 6;

    let array ;

    var dir = true;
    var forwardAllowed = true;
    var backwardAllowed = false;
    var barrier = 0.5;

    var justStarted = true;

    var videoId_old;
    var videoId = 0;
    var currentLable_old;
    var currentLable = 0; // 0 = kein Lable ist gesetzt, zahl entspricht sonst array
    var Walkable = true;
    var changed = false;

    /*
    [Videos
      [Stellen
        [ButtonName, SourceLink, StartTime, EndTime, NewVideoId, NewTime, Walkable, LabelSet]
      ]
    ]
    */
    if (!local){

      beginVideoUrl = 'http://93.90.200.83/res/THG/VID_TrepOst.mp4' ;

      array = [
        [
          ['EG', 'http://93.90.200.83/res/THG/VID_EG_1.mp4', 0, 2, IdEG1, 0, true, false],
          ['1.OG', 'http://93.90.200.83/res/THG/VID_1OG.mp4', 15, 17, Id1OG, 0, true, false],    //Video Treppe ost
          ['2.OG', 'http://93.90.200.83/res/THG/VID_2OG.mp4', 25, 30, Id2OG, 0, true, false],
          ['3.OG', 'http://93.90.200.83/res/THG/VID_3OG.mp4', 40, 45, Id2OG, 0, true, false]
        ],
        [
          ['Treppe', 'http://93.90.200.83/res/THG/VID_TrepOst.mp4', 0, 3, IdTrepOst, 0, true, false],
          ['2-EG', 'http://93.90.200.83/res/THG/VID_EG_2.mp4', 15, 20, IdEG2, 0, true, false],
          ['2-EG', 'http://93.90.200.83/res/THG/VID_EG_2.mp4', 25, 27, IdEG2, 5, true, false],    //Video EG-1 (rechts)
          ['1.OG', 'http://93.90.200.83/res/THG/VID_1OG.mp4', 35, 37, Id1OG, 20, true, false]
        ],
        [
          ['1-EG', 'http://93.90.200.83/res/THG/VID_EG_1.mp4', 0, 3, IdEG1, 16, true, false],     //Video EG-2 (links)
          ['1-EG', 'http://93.90.200.83/res/THG/VID_EG_1.mp4', 5, 7, IdEG1, 26, true, false]
        ],
        [
          ['2.OG', 'http://93.90.200.83/res/THG/VID_2OG.mp4', 40, 44, Id2OG, 0, true, false],
          ['Treppe', 'http://93.90.200.83/res/THG/VID_TrepOst.mp4', 2, 3, IdTrepOst, 15, true, false], // Video OG1
          ['Oberstufe', 'http://93.90.200.83/res/THG/Vid_Oberstufe.mp4', 35, 37, IdObers , 1, false, false]
        ],
        [
          ['3.OG', 'http://93.90.200.83/res/THG/VID_3OG.mp4', 40, 45, Id3OG, 20, true, false],      //Video OG 2
          ['Treppe', 'http://93.90.200.83/res/THG/VID_TrepOst.mp4', 0, 3, IdTrepOst, 30, true, false]
        ],
        [
          ['Treppe', 'http://93.90.200.83/res/THG/VID_TrepOst.mp4', 0, 3, IdTrepOst, 45, true, false] //Video OG 3
        ],
        [
          ['1.OG', 'http://93.90.200.83/res/THG/VID_1OG.mp4', 0, 5, Id1OG, 36, true, false]   //BILD Oberstufenzimmer
        ]

      ];
    }else{

      beginVideoUrl = './res/THG/VID_TrepOst.mp4' ;

      array = [
        [
          ['1.OG', './res/THG/VID_1OG.mp4', 8, 12, 1, 0, true, false], //Video Treppe ost
          ['3.OG', './res/THG/VID_3OG.mp4', 15, 17, 2, 0, true, false]
        ],
        [
          ['3.OG', './res/THG/VID_3OG.mp4', 8, 11, 2, 10, true, false],
          ['Treppe', './res/THG/VID_TrepOst.mp4', 2, 3, 0, 8, true, false], // Video OG1
          ['Oberstufe', './res/THG/Vid_Oberstufe.mp4', 20, 25, 3, 1, false, false]
        ],
        [
          ['1.OG', './res/THG/VID_1OG.mp4', 10, 15, 1, 10, true, false],      //Video OG 3
          ['Treppe', './res/THG/VID_TrepOst.mp4', 0, 3, 0, 15, true, false]
        ],
        [
          ['1.OG', './res/THG/VID_1OG.mp4', 0, 3, 1, 20, true, false],
        ]

      ];

    }

    console.log(array[0][0][0]);

    var p = new Clappr.Player({
      //poster: "https://www.startpage.com/av/proxy-image?piurl=https%3A%2F%2Fencrypted-tbn0.gstatic.com%2Fimages%3Fq%3Dtbn%3AANd9GcRb9IzUh-vm4fdTEQ3oSRtigKgB1YTMh-dECbH7ZutLQMQUGnae%26s&sp=1607379300T0c8dd138c42daef5c0219376c5aef4aff7c9debf296b133c1b30ec9e787b8abc",
      source: beginVideoUrl,
      width: window.innerWidth,
      height: window.innerHeight,
      preload: 'auto',
      chromeless: true,
      mute: true,
      plugins: [Video360],
      parentId: '#player',
      events: {onPlay: function (){
        if (justStarted){
          if (changed){
            p.seek(array[videoId_old][currentLable_old][5]);
            changed = false;
            Walkable = array[videoId_old][currentLable_old][6];
          }
          p.pause();
          justStarted = false;
        }else {
          justStarted = false;
        }
      }
    },
  });
    p.getPlugin('click_to_pause').disable();

    p.core.activePlayback.el.playbackRate = 1;

    p.play();
    //var startTimer = setTimeout(() => {p.pause();}, 1000);

    setInterval(() => {
      if (Walkable){
        if (dir && (p.getCurrentTime() >  (p.getDuration()/2)-barrier)) {
          p.pause();
          forwardAllowed = false;
        } else if (!dir && (p.getCurrentTime() > p.getDuration()-barrier)) {
          p.pause();
          backwardAllowed = false;
        } else {
          forwardAllowed = true;
          backwardAllowed = true;
        }
      }
    }, 100);

    // controll Intervall fÃ¼r Labels
    setInterval(() => {
        for(var i =0; i< array[videoId].length; i++ ){
          try {
            var LabelStart = array[videoId][i][2];
            var LabelEnd = array[videoId][i][3];
            var LabelSet = array[videoId][i][7];
            /*console.log("Start" + LabelStart);
            var control = p.getDuration() - p.getCurrentTime();
            console.log("currentTime_reverse" + control);
            console.log("currentTime" + p.getCurrentTime());
            console.log("Ende" + LabelEnd);*/
            if (p.getCurrentTime() > LabelStart && p.getCurrentTime() < LabelEnd ){
              currentLable = i;
              setLable(currentLable);
              array[videoId][i][7] = true;
            }else if ((p.getDuration()-p.getCurrentTime()) > LabelStart && (p.getDuration() - p.getCurrentTime()) < LabelEnd ) {
              currentLable = i;
              setLable(currentLable);
              array[videoId][i][7] = true;
            }else if (LabelSet){
              array[videoId][i][7] = false;
              hideLable();
              currentLable = 0;
            }
        }catch (e) {
          console.log("Video Id: " + videoId);
          console.log("label check: " + i);
          console.log(e);
        }
      }
    },100);

    setInterval(() => {p.resize({height: window.innerHeight, width: window.innerWidth});}, 1000);

    function setLable(label) {
      document.querySelector(".buttonDiv h1").innerHTML = array[videoId][label][0];
      document.querySelector(".buttonDiv").style.visibility = "visible"
    };

    function hideLable() {
      document.querySelector(".buttonDiv").style.visibility = "collapse"
    };

    function walkForward() {
      if (p.getCurrentTime() > (p.getDuration()/2)) {p.seek(p.getDuration()-p.getCurrentTime());}
      dir = true;
      backwardAllowed = true;
        p.play();
    }

    function walkBackward() {
      if (p.getCurrentTime() < (p.getDuration()/2)) {p.seek(p.getDuration()-p.getCurrentTime());}
      dir = false;
      forwardAllowed = true;
      p.play();
    }

    document.onkeydown = function(e) {
      if (Walkable){
        if ((e.code == "ArrowUp" || e.code == "ArrowRight" || e.code == "KeyW" || e.code == "KeyD") && forwardAllowed) {
          if(Walkable){
            walkForward();
          }
        } else if ((e.code == "ArrowDown" || e.code == "ArrowLeft" || e.code == "KeyA" || e.code == "KeyS") && backwardAllowed) {
          if(Walkable){
            walkBackward();
          }
        }
      }
    };

    document.onkeyup = function(e) {
      if (e.code == "ArrowUp" || e.code == "ArrowRight" || e.code == "KeyW" || e.code == "KeyD") {
        p.pause();
      } else if (e.code == "ArrowDown" || e.code == "ArrowLeft" || e.code == "KeyA" || e.code == "KeyS") {
        p.pause();
      }
    };

    document.querySelector(".buttonDiv").addEventListener("click", (e) => {
      Walkable = false;
      array[videoId][currentLable][7] = false;
      var new_source = array[videoId][currentLable][1];
      changed = true;
      hideLable();
      p.load(array[videoId][currentLable][1]);
      p.play();
      var NewTime = array[videoId][currentLable][5];
      videoId_old = videoId;
      currentLable_old = currentLable;
      videoId = array[videoId][currentLable][4];
      currentLable = 0;
      justStarted = true;
      forwardAllowed = true;
    });

    window.addEventListener("contextmenu", function(e) { e.preventDefault(); });

    document.querySelector(".forward").addEventListener("touchstart", (e) => {walkForward();console.log("Start");});
    document.querySelector(".forward").addEventListener("touchend", (e) => {p.pause();console.log("End");});
    document.querySelector(".backward").addEventListener("touchstart", (e) => {walkBackward();console.log("Start");});
    document.querySelector(".backward").addEventListener("touchend", (e) => {p.pause();console.log("End");});
  </script>
</body>
</html>
